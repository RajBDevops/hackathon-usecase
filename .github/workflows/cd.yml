name: Build and Deploy to AKS

on:
  push:
    branches:
      - main

env:
  ACR_NAME: myacr
  IMAGE_NAME: rajbdocker/my-app
  AKS_RESOURCE_GROUP: your-rg
  AKS_CLUSTER_NAME: my-cluster

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure CLI - Login to ACR
        run: |
          az acr login --name $ACR_NAME

      - name: Build Docker Image
        run: |
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} .

      - name: Push Docker Image to ACR
        run: |
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}

      - name: Set Image Version Output
        id: image
        run: echo "image=$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Kubectl
        uses: azure/setup-kubectl@v3

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group $AKS_RESOURCE_GROUP \
            --name $AKS_CLUSTER_NAME \
            --overwrite-existing

      - name: Deploy to AKS
        run: |
          kubectl set image deployment/my-app-deployment \
            my-app-container=${{ needs.build-and-push.outputs.image }}

          kubectl rollout status deployment/my-app-deployment
