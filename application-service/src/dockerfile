# === Builder stage ===
FROM node:18-alpine AS builder

WORKDIR /usr/src/app

# Install build tools
RUN apk add --no-cache python3 make g++ git

# Copy package.json + package-lock.json first for caching
COPY package*.json ./

# Install all deps (including dev) so build works
RUN npm ci

# Copy the rest of the source code
COPY . .

# (Optional) If you have a build step (e.g. TS, bundling)
# RUN npm run build

# Remove dev dependencies (if you installed them)
RUN npm prune --production

# === Runtime stage ===
FROM node:18-alpine AS runtime

WORKDIR /usr/src/app

# Use a non-root user for better security
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

# Copy production node_modules and source (or built output)
COPY --from=builder /usr/src/app/node_modules ./node_modules
COPY --from=builder /usr/src/app ./

# Set NODE_ENV
ENV NODE_ENV=production

EXPOSE 3000

CMD ["node", "index.js"]


