FROM node:18-alpine

WORKDIR /app

# Required for node-gyp & native builds
RUN apk add --no-cache python3 make g++ bash git

# Copy only package files first
COPY package*.json ./

# Safe install step:
# 1. Try npm ci
# 2. If fails → print logs
# 3. Try npm install
# 4. If still fails → exit build
RUN npm ci \
  || (echo "===== npm ci FAILED — PRINTING LOGS =====" \
      && find /root/.npm/_logs -type f -exec cat {} \; \
      && echo "===== RETRYING WITH npm install =====" \
      && npm install \
      || (echo "===== BOTH npm ci AND npm install FAILED =====" && exit 1))

# Copy remaining source code
COPY . .

# Build if needed (optional)
# RUN npm run build

EXPOSE 3000

CMD ["npm", "index.js"]
